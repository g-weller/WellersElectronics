Checkout 

CHECKOUT PAGE

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - Weller's Electronics</title>
    <link rel="stylesheet" href="../styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>

<body>
    <nav>
        <div class="nav-left">
            <a href="index.html">Home</a>
            <a href="about.html">About</a>
        </div>
        <div class="nav-right">
            <a href="login.html" id="navLogin">Sign In</a>
            <a href="register.html" id="navRegister">Register</a>
            <a href="cart.html" id="navCart">Cart</a>
            <a href="#" id="navLogout">Logout</a>
        </div>
    </nav>

    <div class="checkout-wrapper">
        <div class="checkout-form-section">
            <h2>Checkout</h2>

            <h3>Shipping Information</h3>

            <div class="delivery-options">
                <div class="option-box active" onclick="selectDelivery(this, 'delivery')">
                    <span>Delivery</span>
                </div>
                <div class="option-box" onclick="selectDelivery(this, 'pickup')">
                    <span>Pick up</span>
                </div>
            </div>

            <form id="checkoutForm">
                <div class="form-group">
                    <label>Full name *</label>
                    <input type="text" id="fullName" placeholder="Enter full name" required>
                </div>

                <div class="form-group">
                    <label>Email address *</label>
                    <input type="email" id="email" placeholder="Enter email address" required>
                </div>

                <div class="form-group">
                    <label>Phone number *</label>
                    <input type="tel" id="phone" placeholder="Enter phone number" required>
                </div>

                <div class="form-group">
                    <label>Country *</label>
                    <select id="country" required>
                        <option value="">Choose country</option>
                        <option value="Jamaica">Jamaica</option>
                        <option value="USA">United States</option>
                        <option value="Canada">Canada</option>
                        <option value="UK">United Kingdom</option>
                    </select>
                </div>

                <div class="form-group">
                    <input type="checkbox" id="terms" required>
                    <label for="terms" style="display:inline;">I have read and agree to the Terms and
                        Conditions.</label>
                </div>
            </form>
        </div>

        <div class="checkout-summary-section">
            <h3>Review your cart</h3>

            <div id="orderSummaryList">
            </div>

            <div class="discount-row">
                <input type="text" id="discountCode" placeholder="Enter code (e.g., SAVE10)"> 
                <button type="button" onclick="applyDiscount()">Apply</button>
            </div>
            <p id="discountHint" style="font-size:12px; color:#3057e4; margin-bottom:20px;">
                *Try using **SAVE10** for a $10.00 discount!
            </p>
            
            <div class="cost-line">
                <span>Subtotal</span>
                <span id="subtotalDisplay">$0.00</span>
            </div>
            <div class="cost-line">
                <span>Shipping</span>
                <span id="shippingDisplay">$0.00</span>
            </div>
            <div class="cost-line">
                <span>Discount</span>
                <span id="discountDisplay">-$0.00</span>
            </div>
            <div class="cost-line total">
                <span>Total</span>
                <span id="totalDisplay">$0.00</span>
            </div>

            <button class="pay-btn" onclick="processCheckout()">Pay Now</button>
            <p style="text-align:center; margin-top:10px; font-size:12px; color:#666;">
            </p>
        </div>
    </div>

    <script>
        // SETUP & DATA LOADING //
        let cart = JSON.parse(localStorage.getItem('cart')) || [];
        let currentUserTRN = "000-000-000";

        // Calculation Variables //
        let subtotal = 0;
        let shipping = 15.00;
        let discount = 0;
        let total = 0;

        // RENDERING SECTION//
        function renderSummary() {
            const container = document.getElementById('orderSummaryList');
            container.innerHTML = '';
            subtotal = 0;

            if (cart.length === 0) {
                container.innerHTML = "<p>Your cart is empty.</p>";
            }

            cart.forEach(item => {
                subtotal += (item.price * item.quantity);

                let imgPath = item.image;

                const div = document.createElement('div');
                div.className = 'summary-item';
                div.innerHTML = `
                    <div style="position:relative;">
                        <img src="${imgPath}" class="summary-img" alt="${item.name}">
                        <span style="position:absolute; top:-5px; right:-5px; background:#666; color:white; border-radius:50%; width:20px; height:20px; text-align:center; font-size:12px; line-height:20px;">${item.quantity}</span>
                    </div>
                    <div class="summary-details">
                        <h4>${item.name}</h4>
                        <p>$${item.price.toFixed(2)} each</p>
                    </div>
                    <div>
                        <p>$${(item.price * item.quantity).toFixed(2)}</p>
                    </div>
                `;
                container.appendChild(div);
            });

            updateTotals();
        }

        function updateTotals() {
            document.getElementById('subtotalDisplay').textContent = `$${subtotal.toFixed(2)}`;
            document.getElementById('shippingDisplay').textContent = `$${shipping.toFixed(2)}`;
            document.getElementById('discountDisplay').textContent = `-$${discount.toFixed(2)}`;

            total = subtotal + shipping - discount;
            document.getElementById('totalDisplay').textContent = `$${total.toFixed(2)}`;
        }

        function applyDiscount() {
            const code = document.getElementById('discountCode').value.trim().toUpperCase();
            // This is where the fixed discount is checked.
            if (code === "SAVE10") { 
                discount = 10.00; // Fixed $10.00 discount
                alert("Discount 'SAVE10' applied: $10.00 off!");
            } else {
                discount = 0;
                alert("Invalid code or code already applied.");
            }
            updateTotals();
        }

        function selectDelivery(el, type) {
            // UI Toggle //
            document.querySelectorAll('.option-box').forEach(b => b.classList.remove('active'));
            el.classList.add('active');

            // Logic Toggle //
            if (type === 'pickup') {
                shipping = 0;
            } else {
                shipping = 15.00;
            }
            updateTotals();
        }

        // Â CHECKOUT PROCESS & PDF //
        async function processCheckout() {
            // A. Validation
            const form = document.getElementById('checkoutForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            if (cart.length === 0) {
                alert("Cart is empty!");
                return;
            }

            // B. Data Gathering //
            const fullName = document.getElementById('fullName').value;
            const email = document.getElementById('email').value;
            const phone = document.getElementById('phone').value;
            const country = document.getElementById('country').value;

            const invoiceData = {
                company: "Weller's Electronics",
                date: new Date().toLocaleDateString(),
                invoiceNumber: "INV-" + Date.now(),
                trn: currentUserTRN,
                customer: { name: fullName, email, phone, country },
                items: cart,
                subtotal: subtotal,
                shipping: shipping,
                discount: discount,
                total: total
            };

            // Save to LocalStorage (AllInvoices) //
            let allInvoices = JSON.parse(localStorage.getItem('AllInvoices')) || [];
            allInvoices.push(invoiceData);
            localStorage.setItem('AllInvoices', JSON.stringify(allInvoices));

            // Generate PDF //
            await generatePDF(invoiceData);
            
            // Show confirmation and clear cart
            alert("Order Confirmed! Your receipt has been downloaded.");
            localStorage.removeItem('cart');
            window.location.href = "index.html"; 
        }

        // PDF GENERATOR //
        function generatePDF(data) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Header //
            doc.setFontSize(22);
            doc.setTextColor(48, 87, 228); // Blue
            doc.text(data.company, 105, 20, null, null, "center");

            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            doc.text("Receipt / Invoice", 105, 30, null, null, "center");

            // Customer Info //
            doc.text(`Invoice #: ${data.invoiceNumber}`, 20, 50);
            doc.text(`Date: ${data.date}`, 20, 58);
            doc.text(`Customer: ${data.customer.name}`, 20, 66);
            doc.text(`Email: ${data.customer.email}`, 20, 74);
            // Added phone and country to the receipt
            doc.text(`Phone: ${data.customer.phone}`, 20, 82); 
            doc.text(`Country: ${data.customer.country}`, 20, 90);

            // Table Header //
            let y = 105; // Adjusted starting point
            doc.setFillColor(240, 240, 240);
            doc.rect(20, y - 5, 170, 10, 'F');
            doc.setFont("helvetica", "bold");
            doc.text("Item", 25, y);
            doc.text("Qty", 120, y);
            doc.text("Price", 160, y);

            // Items //
            y += 10;
            doc.setFont("helvetica", "normal");
            data.items.forEach(item => {
                doc.text(item.name, 25, y);
                doc.text(item.quantity.toString(), 120, y);
                doc.text(`$${(item.price * item.quantity).toFixed(2)}`, 160, y);
                y += 10;
            });

            // Total //
            y += 10;
            doc.line(20, y, 190, y);
            y += 10;
            doc.text(`Subtotal: $${data.subtotal.toFixed(2)}`, 140, y);
            y += 8;
            doc.text(`Shipping: $${data.shipping.toFixed(2)}`, 140, y);
            y += 8;
            doc.text(`Discount: -$${data.discount.toFixed(2)}`, 140, y);
            y += 10;

            doc.setFontSize(14);
            doc.setFont("helvetica", "bold");
            doc.text(`Total: $${data.total.toFixed(2)}`, 140, y);

            // Save //
            doc.save(`Receipt-${data.invoiceNumber}.pdf`);

            // Small delay to allow download to start before redirecting or alerting //
            return new Promise(resolve => setTimeout(resolve, 1000));
        }

        // Initialize Page //
        renderSummary();
    </script>
</body>

</html>





Cart

CART PAGE;

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Cart - Weller's Electronics</title>
    <link rel="stylesheet" href="../styles.css">
</head>

<body>
    <nav>
        <div class="nav-left">
            <a href="index.html">Home</a>
            <a href="about.html">About</a>
        </div>
        <div class="nav-right">
            <a href="login.html" id="navLogin">Sign In</a>
            <a href="register.html" id="navRegister">Register</a>
            <a href="cart.html" id="navCart">Cart</a>
            <a href="#" id="navLogout">Logout</a>
        </div>
    </nav>
    <main class="container" style="display:block;">
        <div id="cartPage">
            <h2>Shopping Cart</h2>

            <div class="cart-controls">
                <label>Quick Add:</label>
                <select id="quickProductSelect">
                    <option value="">Select a product...</option>
                </select>
                <input type="number" id="quickQuantity" value="1" min="1" style="width: 60px;">
                <span id="quickPriceDisplay" style="font-weight: bold; min-width: 80px;">$0.00</span>
                <button id="quickAddBtn">Add</button>
            </div>

            <div id="cartTable"></div>

            <div id="totalLine">
                <h4 id="totalCounter">Total: $00.00</h4>
                <button id="checkoutBtn" onclick="window.location.href='checkout.html'">Checkout</button>
            </div>
        </div>
    </main>

    <script>
        // Product Data //
        const defaultProducts = [
            { id: 0, name: "Dell Latitude 3310", price: 300.00, image: "../Assets/Images/laptop_latitude_13_3310_gallery_3.avif" },
            { id: 1, name: "Dell 14 Plus", price: 589.90, image: "../Assets/Images/laptop-dell-db14250-copilot-pc-mg.avif" },
            { id: 2, name: "Dell 15 Laptop", price: 290.99, image: "../Assets/Images/laptop_latitude_13_3310_gallery_3.avif" },
            { id: 3, name: "Inspiron 14 2-in-1", price: 499.99, image: "../Assets/Images/laptop_latitude_13_3310_gallery_3.avif" },
            { id: 4, name: "Dell Slim Desktop", price: 599.99, image: "../Assets/Images/dell-ecs1250-slim-tower-c-rf-no-ssd-cover-bk.avif" },
            { id: 5, name: "Dell Tower Desktop", price: 749.99, image: "../Assets/Images/dell-ect1250-tower-c-rf-bk.avif" },
            { id: 6, name: "Dell Tower Desktop Pro", price: 899.99, image: "../Assets/Images/dell-ect1250-tower-c-rf-bk.avif" },
            { id: 7, name: "Dell Tower Plus", price: 1049.99, image: "../Assets/Images/desktop-tower-ebt2250-gray-cart-480-right.avif" }
        ];

        // Initialize Products in LS if missing //
        if (!localStorage.getItem("AllProducts")) {
            localStorage.setItem("AllProducts", JSON.stringify(defaultProducts));
        }

        const products = JSON.parse(localStorage.getItem("AllProducts"));

        // DOM Elements //
        const selectBox = document.getElementById('quickProductSelect');
        const priceDisplay = document.getElementById('quickPriceDisplay');
        const qtyInput = document.getElementById('quickQuantity');
        const addBtn = document.getElementById('quickAddBtn');

        // Dropdown //
        products.forEach((prod, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = prod.name;
            selectBox.appendChild(option);
        });

        // Selection Changing //
        selectBox.addEventListener('change', () => {
            const index = selectBox.value;
            if (index !== "") {
                const price = products[index].price;
                const qty = parseInt(qtyInput.value) || 1;
                priceDisplay.textContent = "$" + (price * qty).toFixed(2);
            } else {
                priceDisplay.textContent = "$0.00";
            }
        });

        //  Quantity Changing //
        qtyInput.addEventListener('input', () => {
            const index = selectBox.value;
            if (index !== "") {
                const price = products[index].price;
                const qty = parseInt(qtyInput.value) || 1;
                priceDisplay.textContent = "$" + (price * qty).toFixed(2);
            }
        });

        // Add to Cart //
        addBtn.addEventListener('click', () => {
            const index = selectBox.value;
            if (index === "") { alert("Please select a product"); return; }

            const qty = parseInt(qtyInput.value) || 1;
            const product = products[index];

            // Get current cart //
            let cart = JSON.parse(localStorage.getItem('cart')) || [];

            // Check if item exists //
            const existingItem = cart.find(item => item.name === product.name);

            if (existingItem) {
                existingItem.quantity += qty;
            } else {
                cart.push({
                    ...product,
                    quantity: qty
                });
            }

            localStorage.setItem('cart', JSON.stringify(cart));
            renderCart(); 
            alert("Added to cart!");
        });

        // Existing Cart Render  //
        function renderCart() {
            const cartTable = document.getElementById('cartTable');
            const totalCounter = document.getElementById('totalCounter');
            let cart = JSON.parse(localStorage.getItem('cart')) || [];

            if (cart.length === 0) {
                cartTable.innerHTML = "<p>Your cart is empty.</p>";
                totalCounter.innerText = "Total: $0.00";
                return;
            }

            let html = `<table style="width:100%">
                    <tr><th>Product</th><th>Price</th><th>Qty</th><th>Total</th><th>Action</th></tr>`;

            let grandTotal = 0;

            cart.forEach((item, idx) => {
                const itemTotal = item.price * item.quantity;
                grandTotal += itemTotal;
                html += `
                        <tr>
                            <td>${item.name}</td>
                            <td>$${item.price.toFixed(2)}</td>
                            <td>${item.quantity}</td>
                            <td>$${itemTotal.toFixed(2)}</td>
                            <td><button onclick="removeItem(${idx})" style="margin:0; width:auto; background:red; color:white;">X</button></td>
                        </tr>
                    `;
            });

            html += "</table>";
            cartTable.innerHTML = html;
            totalCounter.innerText = "Total: $" + grandTotal.toFixed(2);
        }

        function removeItem(index) {
            let cart = JSON.parse(localStorage.getItem('cart')) || [];
            cart.splice(index, 1);
            localStorage.setItem('cart', JSON.stringify(cart));
            renderCart();
        }

        // Initial Render //
        renderCart();

    </script>
</body>


CSS

/*Checkout & New Cart Styles*/

:root {
    --primary-blue: #3057e4; 
    --bg-gray: #f9fafb;
    --border-color: #e5e7eb;
}

/* Utilities */
.hidden { display: none; }
.text-right { text-align: right; }

/* Cart Page Dropdown Section */
.cart-controls {
    background: var(--bg-gray);
    padding: 20px;
    margin: 20px 50px;
    border: 1px solid var(--border-color);
    display: flex;
    gap: 10px;
    align-items: center;
}

.cart-controls select, .cart-controls input {
    padding: 8px;
    border: 1px solid #ccc;
    height: 40px;
}

.cart-controls button {
    margin-top: 0;
    width: auto;
    padding: 0 20px;
    height: 40px;
    background-color: var(--primary-blue);
    color: white;
    border: none;
    cursor: pointer;
}

/* Checkout Grid Layout */
.checkout-wrapper {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0;
    width: 100%;
    max-width: 1200px;
    margin: 0 auto;
    min-height: 80vh;
}

/* Left Side: Form */
.checkout-form-section {
    padding: 40px;
    background: #fff;
}

.checkout-form-section h2 {
    margin-bottom: 20px;
    font-size: 24px;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    font-size: 14px;
}

.form-group input, .form-group select {
    width: 100%;
    padding: 12px;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    font-size: 14px;
}

/* Delivery Toggle */
.delivery-options {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
}

.option-box {
    flex: 1;
    border: 1px solid var(--border-color);
    padding: 15px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
}

.option-box.active {
    border-color: var(--primary-blue);
    background-color: #f0f4ff;
}

/* Right Side: Summary */
.checkout-summary-section {
    background-color: var(--bg-gray);
    padding: 40px;
    border-left: 1px solid var(--border-color);
}

.summary-item {
    display: flex;
    gap: 15px;
    margin-bottom: 20px;
    align-items: center;
}

.summary-img {
    width: 60px;
    height: 60px;
    object-fit: cover;
    border-radius: 6px;
    border: 1px solid #ddd;
    background: #fff;
}

.summary-details {
    flex: 1;
}

.summary-details h4 { font-size: 14px; margin-bottom: 4px; }
.summary-details p { font-size: 12px; color: #666; }

.discount-row {
    display: flex;
    gap: 10px;
    margin: 20px 0;
}

.discount-row input { flex: 1; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px;}
.discount-row button { 
    margin: 0; width: auto; background: transparent; color: var(--primary-blue); 
    border: none; font-weight: bold; cursor: pointer;
}

.cost-line {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
    font-size: 14px;
    color: #555;
}

.cost-line.total {
    font-size: 18px;
    font-weight: bold;
    color: #000;
    margin-top: 20px;
    border-top: 1px solid var(--border-color);
    padding-top: 20px;
}

.pay-btn {
    width: 100%;
    background-color: var(--primary-blue);
    color: white;
    padding: 18px; 
    border: none;
    border-radius: 6px;
    font-size: 18px;
    font-weight: bold; 
    cursor: pointer;
    margin-top: 25px; 
    box-shadow: 0 4px 15px rgba(48, 87, 228, 0.4); 
    transition: background-color 0.3s, box-shadow 0.3s;
}

.pay-btn:hover {
    filter: brightness(0.9);
    box-shadow: 0 6px 20px rgba(48, 87, 228, 0.6); /* More pronounced shadow on hover */
}

.pay-btn:hover {
    filter: brightness(0.9);
}

/* Media Query for Mobile */
@media (max-width: 768px) {
    .checkout-wrapper { grid-template-columns: 1fr; }
    .checkout-summary-section { order: -1; border-left: none; border-bottom: 1px solid var(--border-color);}
}


Invoice
// Ensure the jsPDF library is loaded in your HTML, e.g., in checkout.html:
// <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

// --Invoice Data Structure Example (Syntax Fixed)--
const exampleInvoice = {
    invoiceNum: 'INV-20251206-001',
    companyName: 'Weller\'s Electronics',
    date: '2025-12-06', // Added missing comma
    trn: '001-234-567',
    shippingInfo: {
        address: '123 Main St, Kingston, Jamaica',
        recipient: 'Jane Doe',
        phone: '876-555-1234'
    },
    purchasedItems: [
        { name: 'Laptop Pro', quantity: 1, unitPrice: 1500.00, discount: 0.00 },
        { name: 'Wireless Mouse', quantity: 2, unitPrice: 25.00, discount: 5.00 }
    ],
    subtotal: 1545.00,
    taxes: 231.75,
    totalCost: 1776.75
};

// --PDF Generation Helper Function--
/**
 * Downloads the given invoice data as a PDF document.
 * @param {object} data - The complete invoice object to print.
 */
function downloadInvoicePDF(data) {
    // Access the jsPDF library from the window object
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    // --- PDF Content Generation ---
    const BLUE_COLOR = [48, 87, 228]; // Same blue as the checkout page

    // Header 
    doc.setFontSize(22);
    doc.setTextColor(BLUE_COLOR[0], BLUE_COLOR[1], BLUE_COLOR[2]);
    doc.text(data.companyName, 105, 20, null, null, "center");

    doc.setFontSize(12);
    doc.setTextColor(0, 0, 0);
    doc.text("Receipt / Invoice", 105, 30, null, null, "center");

    // Recipient Info (Based on shippingInfo in the example structure)
    doc.text(`Invoice #: ${data.invoiceNumber}`, 20, 50);
    doc.text(`Date: ${data.dateOfInvoice}`, 20, 58);
    doc.text(`TRN: ${data.trn}`, 20, 66);
    
    // Recipient Details
    doc.setFont("helvetica", "bold");
    doc.text("Billed To:", 105, 50);
    doc.setFont("helvetica", "normal");
    // Assuming required fields (recipient, address, phone) exist in shippingInformation
    const shipping = data.shippingInformation;
    doc.text(`Name: ${shipping.recipient || 'N/A'}`, 105, 58); 
    doc.text(`Address: ${shipping.address || 'N/A'}`, 105, 66);
    doc.text(`Phone: ${shipping.phone || 'N/A'}`, 105, 74);


    // Table Header 
    let y = 100;
    doc.setFillColor(240, 240, 240);
    doc.rect(20, y - 5, 170, 10, 'F');
    doc.setFont("helvetica", "bold");
    doc.text("Item", 25, y);
    doc.text("Qty", 100, y);
    doc.text("Unit Price", 130, y);
    doc.text("Total", 170, y);

    // Items 
    y += 10;
    doc.setFont("helvetica", "normal");
    data.purchasedItems.forEach(item => {
        // Correctly calculate line item total
        const lineTotal = (item.quantity * item.unitPrice) - (item.discount || 0); 
        doc.text(item.name, 25, y);
        doc.text(item.quantity.toString(), 100, y);
        doc.text(`$${item.unitPrice.toFixed(2)}`, 130, y);
        doc.text(`$${lineTotal.toFixed(2)}`, 170, y);
        y += 7; // Use smaller increment for items
    });

    // Totals
    y += 10;
    doc.line(20, y, 190, y);
    y += 10;
    
    doc.text(`Subtotal (Pre-tax): $${data.subtotal.toFixed(2)}`, 140, y);
    y += 8;
    if (data.totalDiscount > 0) {
        doc.text(`Cart Discount: -$${data.totalDiscount.toFixed(2)}`, 140, y);
        y += 8;
    }
    doc.text(`Taxes (15%): $${data.taxes.toFixed(2)}`, 140, y);
    y += 10;

    doc.setFontSize(14);
    doc.setFont("helvetica", "bold");
    doc.text(`TOTAL COST: $${data.totalCost.toFixed(2)}`, 140, y);

    // Save
    doc.save(`Invoice-${data.invoiceNumber}.pdf`);
    console.log(`Invoice PDF downloaded: Invoice-${data.invoiceNumber}.pdf`);
}


// --Core Invoice Generation Function (Fixed)--
/**
 * Generates an invoice, saves it to the current user's data,
 * and also stores all invoices in local storage.
 * It also triggers the download of the invoice as a PDF.
 * @param {object} checkoutData - Data from the checkout form and cart. Expected: { items, shippingInfo, totalDiscount (optional) }
 * @param {object} currentUser - The user's account object. Expected: { trn, invoices (optional) }
 */
function generateInvoice(checkoutData, currentUser) {
    // A. Metadata Generation
    const date = new Date().toISOString().split('T')[0];
    const invoiceNumber = 'INV-' + date.replace(/-/g, '') + '-' + Math.floor(Math.random() * 10000).toString().padStart(4, '0');
    const TAX_RATE = 0.15; // 15% Tax

    // B. Calculations
    let itemsSubtotal = 0; // Subtotal based on (Qty * Price) - Discount
    
    // NOTE: This logic assumes 'unitPrice' and 'discount' properties exist on the item object in the cart.
    checkoutData.items.forEach(item => {
        const discountPerItem = item.discount || 0.00;
        const itemLineTotal = (item.quantity * item.unitPrice) - discountPerItem;
        itemsSubtotal += itemLineTotal;
    });

    const cartDiscount = checkoutData.totalDiscount || 0.00; // Total cart-level discount
    const subtotal = itemsSubtotal; // Subtotal (pre-tax, post-item-discount)
    const taxes = subtotal * TAX_RATE; // Correct calculation: Subtotal * Tax Rate
    const totalCost = subtotal - cartDiscount + taxes; // Fixed total calculation

    // C. Create Invoice Object (Fixed syntax)
    const newInvoice = {
        companyName: 'Weller\'s Electronics',
        dateOfInvoice: date,
        shippingInformation: checkoutData.shippingInfo, // Shipping info (address, recipient, phone)
        invoiceNumber: invoiceNumber,
        trn: currentUser.trn || '011-234-567', // Use TRN from current user if available
        purchasedItems: checkoutData.items.map(item => ({ // Fixed syntax using implicit return
            name: item.name,
            quantity: item.quantity,
            unitPrice: item.unitPrice || item.price, // Use unitPrice if available, fallback to price
            discount: item.discount || 0.00
        })),
        taxes: parseFloat(taxes.toFixed(2)),
        subtotal: parseFloat(subtotal.toFixed(2)),
        totalDiscount: parseFloat(cartDiscount.toFixed(2)),
        totalCost: parseFloat(totalCost.toFixed(2))
    };

    // D. Data Storage
    // Append User's Array of Invoices (Fixed 'current' typo)
    if (!currentUser.invoices) {
        currentUser.invoices = [];
    }
    currentUser.invoices.push(newInvoice);
    console.log(`Invoice ${invoiceNumber} created and appended to user data.`);

    // Store Invoice in Local Storage
    let allInvoices = JSON.parse(localStorage.getItem('AllInvoices')) || [];
    allInvoices.push(newInvoice);
    localStorage.setItem('AllInvoices', JSON.stringify(allInvoices));
    console.log('Invoice stored in localStorage under AllInvoices.');

    // E. PDF Generation (New)
    downloadInvoicePDF(newInvoice);

    return newInvoice;
}


// --Additional Functionality (Unchanged, included for completeness)--
const AGE_GROUPS = [
    { label: '18-25', min: 18, max: 25 },
    { label: '26-35', min: 26, max: 35 },
    { label: '36-50', min: 36, max: 50 },
    { label: '50+', min: 51, max: Infinity }
];

function calculateAge(dobString) {
    const today = new Date();
    const birthDate = new Date(dobString);
    let age = today.getFullYear() - birthDate.getFullYear();
    const m = today.getMonth() - birthDate.getMonth();
    if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
        age--;
    }
    return age;
}

function ShowUserFrequency() {
    const usersData = JSON.parse(localStorage.getItem('RegisterData')) || [];

    if (usersData.length === 0) {
        console.log("No registered user data found.");
        return;
    }

    const genderFrequency = usersData.reduce((acc, user) => {
        const gender = user.gender || 'Not Specified';
        acc[gender] = (acc[gender] || 0) + 1;
        return acc;
    }, {});

    const ageGroupFrequency = AGE_GROUPS.reduce((acc, group) => {
        acc[group.label] = 0;
        return acc;
    }, {});

    usersData.forEach(user => {
        if (user.dob) {
            const age = calculateAge(user.dob);
            const group = AGE_GROUPS.find(g => age >= g.min && age <= g.max);
            if (group) {
                ageGroupFrequency[group.label]++;
            }
        }
    });

    //Display Data on Dashboard/Console
    const dashboardData = {
        gender: genderFrequency,
        ageGroups: ageGroupFrequency
    };

    console.log("--USER FREQUENCY ANALYSIS--");
    console.log("Gender Distribution:", dashboardData.gender);
    console.log("Age Group Distribution:", dashboardData.ageGroups);
}

/**
 * Displays all stored invoices. Can filter by TRN.
 * @param {string} trnToSearch
 */
function ShowInvoices(trnToSearch = null) {
    const allInvoices = JSON.parse(localStorage.getItem('AllInvoices')) || [];

    if (allInvoices.length === 0) {
        console.log("No invoices stored in localStorage (AllInvoices).");
        return;
    }

    console.log("-- -ALL STORED INVOICES- --");

    let invoicesToDisplay = allInvoices;

    if (trnToSearch) {
        invoicesToDisplay = allInvoices.filter(invoice => invoice.trn === trnToSearch);
        console.log(`Filtering by TRN: ${trnToSearch}`);
    }

    if (invoicesToDisplay.length === 0) {
        console.log(`No invoices found for TRN: ${trnToSearch}.`);
    } else {
        invoicesToDisplay.forEach((invoice, index) => {
            console.log(`Invoice #${index + 1}:`);
            console.log(`  Inv. No.: ${invoice.invoiceNumber}`);
            console.log(`  Date: ${invoice.dateOfInvoice}`);
            console.log(`  TRN: ${invoice.trn}`);
            console.log(`  Total: $${invoice.totalCost}`);
            console.log('---');
        });
    }
}

/**
 * Display invoices of a specified user based on TRN
 * @param {string} trnToSearch
 */
function GetUserInvoices(trnToSearch) {
    const allUsers = JSON.parse(localStorage.getItem('RegisterData')) || [];

    //Makes TRN unique indentifier
    const targetUser = allUsers.find(user => user.trn === trnToSearch);

    if (!targetUser) {
        console.log(`User with TRN ${trnToSearch} not found in RegisterData`);
        return;
    }

    const userInvoices = targetUser.invoices || [];

    console.log(`--- INVOICES FOR USER (TRN: ${trnToSearch}) ---`);

    if (userInvoices.length === 0) {
        console.log(`User ${trnToSearch} has no recorded invoices.`);
    } else {
        userInvoices.forEach((invoice, index) => {
            console.log(`Invoice #${index + 1}:`);
            console.log(`  Inv. No.: ${invoice.invoiceNumber}`);
            console.log(`  Date: ${invoice.dateOfInvoice}`);
            console.log(`  Total: $${invoice.totalCost}`);
            console.log('---');
        })
    }
}